<!DOCTYPE html>
<html lang = "en">
<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <title>Upload JSON Comparison</title>
  <style>
    table, td, th, tr {
    border-collapse:collapse;
    border:1px solid black; 
    padding:2px; 
    }
    tr.alt1 { background-color:#E0E0E0; }
    tr.alt2 { background-color:#FFFFFF; }
    .prop { margin-left: 30px; margin-top: 2px; margin-bottom: 2px; }
    .alg { margin-left: 60px; margin-top: 2px; margin-bottom: 2px;}
    .tool { margin-left: 90px; margin-top: 2px; margin-bottom: 2px;}
    .toolprop { margin-left: 120px; margin-top: 2px; margin-bottom: 2px;}
    a:link,a:visited {text-decoration:none}
    a:hover {text-decoration:underline}
    .hidden { display: none; }
    .unhidden { display: block; }
  
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 15px;
      background-color: #f4f4f4;
      color: #333;
    }
    main {
      max-width: 1350px;
      margin: 15px auto;
      padding: 30px;
      background: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
    }
    header img {
      width: 170px;
    }
    h1 {
      font-size: 26px;
      color: #0056b3;
    }
    h2 {
      font-size: 20px;
      color: #333;
      border-bottom: 2px solid #0056b3;
      padding-bottom: 5px;
    }
    p, li {
      margin: 10px 0;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      background: #eee;
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
    }
    a {
      text-decoration: none;
      color: #0056b3;
    }
    a:hover {
      text-decoration: underline;
    }
    .note {
      font-style: italic;
      color: #555;
    }
    .contact {
      margin-top: 20px;
    }
    .columns {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    .column {
      flex: 1;
      min-width: 0;
    }
    @media (max-width: 900px) {
      .columns {
        flex-direction: column;
      }
      main {
        margin: 10px;
        padding: 15px;
      }
      h1 {
        font-size: 20px;
      }
      h2 {
        font-size: 18px;
      }
      li {
        padding: 8px;
      }
    }
    .table th,
    .table td {
         width: 50px;
         word-wrap: break-word;
         font-size: 14px;
         padding: 2px;
         padding-left: 6px;
     }
     .table th { 
         text-align: left !important;
         color: white; 
     }
     .table {
         table-layout: fixed;
         margin-bottom: 20px; 
     }
     .table-container {
         position: relative;
     }
     .center {
         display: block;
         margin-left: auto;
         margin-right: auto;
         width: 45%;
     }
     .collapsible {
       background-color: cornflowerblue;
       color: white;
       cursor: pointer;
       padding: 5px;
       width: 100%;
       border: 1px solid #dee2e6;
       text-align: left;
       outline: none;
       font-size: 14px;
     }
     .content {
       padding-left: 50px;
       display: none;
       overflow: hidden;
     }
     .button {
       background-color: #8f8d8d;
       color: white;
       padding: 5px 10px;
       text-align: center;
       display: inline-block;
       font-size: 20px;
       margin-right: 5px;
       border-radius: 8px;
       border: none;
     }
     .button:focus {     
       background-color: #8f8d8d;
       color: white;
       padding: 5px 10px;
       text-align: center;
       display: inline-block;
       font-size: 20px;
       margin-right: 5px;
       border-radius: 8px;
       border: 2px solid black;
     }
     .faq {     
       background-color: #8f8d8d;
       color: white;
       padding: 3px 11px;
       text-align: center;
       display: inline-block;
       font-size: 15px;
       border: none;
       border-radius: 100%;
       position: relative;
     }
     .faqtext {
       visibility: hidden;
       width: 500px;
       background-color: rgba(0, 7, 10, 0.8);
       color: #fff;
       text-align: left;
       padding: 20px 20px;
       border-radius: 6px;
       position: absolute;
       z-index: 1;
       bottom: 120%;
       left: 50%;
       margin-left: -475px;
     }
     .faq:hover .faqtext {
       visibility: visible;
     }
  </style>
</head>
<body>
  <main>
    <header>
      <img src="https://atlas.cern/sites/default/files/inline-images/ATLAS%20logo%20default%20RGBHEX%2072ppi.png" alt="ATLAS logo"><br><br>
      <h1><b>JSON Comparison Tool</b></h1><br>
    </header>
<p>Comparison outputs do not save, so please copy any critical files to a more permanent location (download only available in table view). To create the JSON configuration file for a specific p-tag, follow the instructions on the <a href="https://gitlab.cern.ch/jprobert/analysis_config">Gitlab page</a>.</p><br>


  <div style="display: flex; justify-content: center;">
    <input id="json1" type="file" name="json1" accept=".json" required><br><br>
  </div>
  <div style="display: flex; justify-content: center;">
    <input type="file" id="json2" name="json2" accept=".json" required><br><br>
  </div>
 <div style="display: flex; justify-content: center;">
    <input type="submit" onclick="startCompare()">
</div><br>

  <div id="buttons"></div>
  <div id="result"></div>
  <script>
    let jsonDiff = {};
    let withoutNP = {};
    let currentView = "table";
    let fileNames = [];
    let curParticle = "None";
    let curPresent = true;

   const skipPrintList = [
      "ExtraInputs", "ExtraOutputs", "THistSvc", "Timeline", "DetStore", "EvtStore", 
      "MonitorService", "NeededResources", "OutputLevel", "RegisterForContextService", "RootStreamName"
    ];
    const particleTypes = ["Electron", "Jet", "Muon", "Photon", "Tau", "Other"];
 
    //sets global valuables back to default
    function resetGlobals () {
       jsonDiff = {};
       withoutNP = {};
       currentView = "table";
       fileNames = [];
       curParticle = "None";
       curPresent = true;
    }
    
    //compares input files and renders output as dropdown all view
    function startCompare() {
      resetGlobals ();
      const file1 = document.getElementById("json1").files[0];
      const file2 = document.getElementById("json2").files[0];

      fileNames = [file1.name.replace('.json', ''), file2.name.replace('.json', '')];

      const reader1 = new FileReader();
      const reader2 = new FileReader();

      reader1.onload = function(e) {
        const data1 = JSON.parse(e.target.result);
        reader2.onload = function(e2) {
          const data2 = JSON.parse(e2.target.result);
      

          doComparison1(data1, data2, "");
          doComparison2(data1, data2, "");

          document.getElementById("buttons").innerHTML = renderButtons();
          renderTable(jsonDiff);
        };
        reader2.readAsText(file2);
      };
      reader1.readAsText(file1);
    }
    
   //recursively compares files, stores path to difference as a string separated by :
    function doComparison1(json1, json2, path) {
      for (const key in json1) {
        const value1 = json1[key];
        const value2 = json2 ? (json2[key] ?? "<i>[not present]</i>") : "<i>[not present]</i>";
        if (JSON.stringify(value1) !== JSON.stringify(value2)) {
          if (typeof value1 === "object" && !Array.isArray(value1) && value1 !== null) {
            doComparison1(value1, value2, path + ":" + key);
          } else if (!skipPrintList.includes(key)) {
            if (value2 !== "<i>[not present]</i>") {
               withoutNP[path + ":" + key] = [value1, value2]; //NP = [not present]
            }
            jsonDiff[path + ":" + key] = [value1, value2];   //stores path to difference as a string separated by :
          }
        }
      }
    }
    
    //recursively compares files, stores only if present in json2 and not json1
    function doComparison2(json1, json2, path) {
      for (const key in json2) {
        const value2 = json2[key];
        const value1 = json1 ? (json1[key] ?? "<i>[not present]</i>") : "<i>[not present]</i>";
        if (JSON.stringify(value1) !== JSON.stringify(value2)) {
          if (typeof value2 === "object" && !Array.isArray(value2) && value2 !== null) {
            doComparison2(value1, value2, path + ":" + key);
          } else if (value1 === "<i>[not present]</i>" && !skipPrintList.includes(key)) {
            jsonDiff[path + ":" + key] = [value1, value2];
          }
        }
      }
    }
  
   //recursively makes dict representation of string path to value
    function checkOrganized(dict, pathList, value) {
      if (pathList.length === 1) {
        dict[pathList[0]] = value;
      } else {
        const key = pathList[0];
        if (!dict[key]) dict[key] = {};
        checkOrganized(dict[key], pathList.slice(1), value);
      }
    }
    
    //creates string of html code for all buttons on page
    function renderButtons() {
      let html = '<br><form>';
      html += `<button type="button" class="button" onclick="getAllPage()" autofocus>All</button>`;
      for (const p of particleTypes) {
        if (curPresent === true) {
            html += `<button type="button" class="button" onclick="filterByParticle('${p}', jsonDiff)">${p}</button>`;
        } else { 
            html += `<button type="button" class="button" onclick="filterByParticle('${p}', withoutNP)">${p}</button>`;
        }
      }
      html += `</form><button class="button float-right" onclick="toggleNotPresent()"> View with${curPresent === true ? 'out' : ''} <i>[not present]</i></button>`;
      html += `<button class="button float-right" onclick="toggleView()">View as ${currentView === 'dropdown' ? 'table' : "dropdown"}</button>`;
      if (currentView === "table") {
         html += `<button class="button float-right" onclick="downloadCSV('jsonDiffOut')">Download as CSV</button>`;
      }
      return html;
    }
    
    //downloads table given by table_id as CSV file
    function downloadCSV(table_id, separator = ',') {
        var rows = document.querySelectorAll('table#' + table_id + ' tr');
        var csv = [];
        for (var i = 0; i < rows.length; i++) {
            var row = [];
            var cols = rows[i].querySelectorAll('td, th');
            for (var j = 0; j < cols.length; j++) {
                var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
                data = data.replace(/"/g, '""');
                row.push('"' + data + '"');
             }
             csv.push(row.join(separator));
         }
         var csv_string = csv.join('\n').slice(1);
         var filename = fileNames[0] + "_" + fileNames[1]+ "_" + curParticle+ "_" + curPresent + ".csv";
         var link = document.createElement('a');
         link.style.display = 'none';
         link.setAttribute('target', '_blank');
         link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
         link.setAttribute('download', filename);
         document.body.appendChild(link);
         link.click();
        document.body.removeChild(link);
    }

    //writes all differences to page (for "All" particle button)
    function getAllPage() {
      curParticle = "None";
      currentView = currentView === "dropdown" ? "table" : "dropdown";
      toggleView();
    }
 
    //gets all differences containing particle and writes out to page
    function filterByParticle(particle, diffDict) {
      curParticle = particle;
      let filtered;
      if (currentView === "dropdown") {
        filtered = {};
        Object.keys(diffDict).forEach(key => {
          const path = key.split(":").slice(1).join(":");
          if (matchParticle(particle, path)) {
            checkOrganized(filtered, key.split(":").slice(1), diffDict[key]);
          }
        });
        renderDropdown(filtered);
      } else {
        filtered = {};
        Object.keys(diffDict).forEach(key => {
          const path = key.split(":").slice(1).join(":");
          if (matchParticle(particle, path)) {
            filtered[key] = diffDict[key];
          }
        });
        renderTable(filtered);
      }
    }
 
    //checks if path contains particle, if electron/proton also if contains "gamma"
    function matchParticle(particle, path) {
      if (particle === "Other") { 
        return !particleTypes.slice(0, -1).some(p => path.includes(p)) && !path.includes("gamma");
      }
      return path.includes(particle) || (["Electron", "Photon"].includes(particle) && path.includes("gamma"));
    }
  
    //toggles [not present] on and off and renders page with correct results
    function toggleNotPresent() {
      curPresent = curPresent === true ? false : true;
      document.getElementById("buttons").innerHTML = renderButtons();
       if (currentView === "dropdown") {
        if (curParticle === "None") {
            curPresent ? renderDropdownPage(jsonDiff) : renderDropdownPage(withoutNP);
        } else {
            curPresent ? filterByParticle(curParticle, jsonDiff) : filterByParticle(curParticle, withoutNP);
        }
      } else {
         if (curParticle === "None") {
            curPresent ? renderTable(jsonDiff) : renderTable(withoutNP);
        } else {
            curPresent ? filterByParticle(curParticle, jsonDiff) : filterByParticle(curParticle, withoutNP);
        }
      }
    }
 
    //toggles between dropdown and table views, and renders page with correct results
    function toggleView() {
      currentView = currentView === "dropdown" ? "table" : "dropdown";
      document.getElementById("buttons").innerHTML = renderButtons();
      if (currentView === "dropdown") {
        if (curParticle === "None") {
            curPresent ? renderDropdownPage(jsonDiff) : renderDropdownPage(withoutNP);
        } else {
            curPresent ? filterByParticle(curParticle, jsonDiff) : filterByParticle(curParticle, withoutNP);
        }
      } else {
         if (curParticle === "None") {
            curPresent ? renderTable(jsonDiff) : renderTable(withoutNP);
        } else {
            curPresent ? filterByParticle(curParticle, jsonDiff) : filterByParticle(curParticle, withoutNP);
        }
      }
    }

    //makes a page in the dropdown view
    function renderDropdownPage(diff) {
      organizeDiff = {};
      for (const key in diff) {
        checkOrganized(organizeDiff, key.split(":").slice(1), diff[key]);
      }
      renderDropdown(organizeDiff);
    }
 

    //makes the dropdowns on a page
    function renderDropdown(diffDict) {
      const container = document.getElementById("result");
      container.innerHTML = `<p>Number of differences: ${countDiffs(diffDict)}</p>`;
      const html = document.createElement("div");
      appendDropdowns(diffDict, html);
      container.appendChild(html);
      setupCollapsibles();
    }
    
    //adds dropdowns html code to existing location on page
    function appendDropdowns(obj, parent) { 
      for (const key in obj) {
        if (typeof obj[key] === "object" && !Array.isArray(obj[key])) {
          const btn = document.createElement("button");
          btn.className = "collapsible";
          btn.textContent = key;
          const div = document.createElement("div");
          div.className = "content";
          parent.appendChild(btn);
          parent.appendChild(div);
          appendDropdowns(obj[key], div);
        } else {
          if (!parent.querySelector("table")) {
            const table = document.createElement("table-container");
            table.innerHTML = `<table border="1" class= "data frame table table-striped table-bordered" id="jsonDiffOut"><thead><tr style="background-color:#8f8d8d;"><th>Config Type</th><th>${fileNames[0]}</th><th>${fileNames[1]}</th></tr></thead><tbody></tbody></table>`;
            parent.appendChild(table);
          }
          const tbody = parent.querySelector("table tbody");
          const row = document.createElement("tr");
          row.innerHTML = `<td>${key}</td><td>${obj[key][0]}</td><td>${obj[key][1]}</td>`;
          tbody.appendChild(row);
        }
      }
    }
 
    //adds collapsible functionality to dropdowns
    function setupCollapsibles() {
          const coll = document.getElementsByClassName("collapsible");
          for (let i = 0; i < coll.length; i++) {
              coll[i].addEventListener("click", function () {
                this.classList.toggle("active");
                const content = this.nextElementSibling;
                const isOpen = content.style.display === "block";
      
                content.style.display = isOpen ? "none" : "block";

                if (!isOpen) {
                  const nestedButtons = content.getElementsByClassName("collapsible");
                  for (let j = 0; j < nestedButtons.length; j++) {
                    const nested = nestedButtons[j];
                    nested.classList.add("active");
                    const nestedContent = nested.nextElementSibling;
                    if (nestedContent) nestedContent.style.display = "block";
                  }
                }
              });
           }
    }
 
    //makes three column table of differences
    function renderTable(diff) {
      const container = document.getElementById("result");
      container.innerHTML = `<p>Number of differences: ${Object.keys(diff).length}</p>`;
      const table = document.createElement("table-container");
      table.innerHTML = `<table border="1" class= "data frame table table-striped table-bordered" id="jsonDiffOut"><thead><tr style="background-color:cornflowerblue;"><th>Config Type</th><th>${fileNames[0]}</th><th>${fileNames[1]}</th></tr></thead><tbody></tbody></table>`;
      for (const key in diff) {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${key.split(":").slice(1).join(":")}</td><td>${diff[key][0]}</td><td>${diff[key][1]}</td>`;
        table.querySelector("tbody").appendChild(row);
      }
      container.appendChild(table);
    }

    //counts differences in a given dictionary
    function countDiffs(tree) {
      let count = 0;
      for (const key in tree) {
        if (typeof tree[key] === "object" && !Array.isArray(tree[key])) {
          count += countDiffs(tree[key]);
        } else {
          count++;
        }
      }
      return count;
    }
  </script>
<div class="Contact">
      <p>Contact: website/content bugs or suggestions (<a href="mailto:heather.russell@cern.ch">heather.russell@cern.ch</a>), General support (<a href="mailto:atlas-phys-amg-conveners@cern.ch">atlas-phys-amg-conveners@cern.ch</a>)</p>
      <div class="faq" style="float: right;">?
        <span class="faqtext">
             <u>FAQ</u><br><i>Q: What does the [not present] tag mean?</i><br><i>A:</i> This field was not present in the provided file, but was in the other.<br><br>
                                          <i>Q: Are any configurations not included in the output?</i><br><i>A:</i> Yes, the following configurations are not displayed, but can be viewed in the JSON file: <b>ExtraInputs</b>, <b>ExtraOutputs</b>, <b>THistSvc</b>, <b>Timeline</b>, <b>DetStore</b>, <b>EvtStore</b>, <b>MonitorService</b>, <b>NeededResources</b>, <b>OutputLevel</b>, <b>RegisterForContextService</b>, <b>RootStreamName</b>.</p>
     </button>
 </div><br>
</body>
</html>